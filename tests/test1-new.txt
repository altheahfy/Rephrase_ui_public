  /**
   * Test-1: DBã«å­˜åœ¨ã™ã‚‹å…¨ã¦ã®ã‚µãƒ–ã‚¹ãƒ­ãƒƒãƒˆãŒç”»é¢ä¸Šã«ä¸€åº¦ä»¥ä¸Šè¡¨ç¤ºã•ã‚Œã‚‹ã‹
   * 
   * ç›®çš„: DBã«å­˜åœ¨ã™ã‚‹ã‚µãƒ–ã‚¹ãƒ­ãƒƒãƒˆæ§‹é€ ãŒã€UIè¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯ä¸Šã§æ¬ è½ã—ã¦ã„ãªã„ã“ã¨ã‚’ä¿è¨¼
   * 
   * ãƒ­ã‚¸ãƒƒã‚¯:
   * 1. DBå†…ã®å„ä¾‹æ–‡ã«ã¤ã„ã¦ã€è¦ªã‚¹ãƒ­ãƒƒãƒˆã”ã¨ã®ã‚µãƒ–ã‚¹ãƒ­ãƒƒãƒˆæ§‹é€ ã‚’ãƒãƒƒãƒ—åŒ–
   *    ä¾‹: make/ex007 â†’ S ã« [sub-s, sub-aux, sub-m2, sub-v, sub-o1]
   * 2. ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºã§å„ä¾‹æ–‡ã‚’è¡¨ç¤ºã—ã€å„è¦ªã‚¹ãƒ­ãƒƒãƒˆã®ã‚µãƒ–ã‚¹ãƒ­ãƒƒãƒˆãŒå…¨ã¦è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
   * 3. DBå†…ã®å…¨ã‚µãƒ–ã‚¹ãƒ­ãƒƒãƒˆçµ„ã¿åˆã‚ã›ï¼ˆè¦ª+ã‚µãƒ–ï¼‰ãŒUIã«å‡ºç¾ã™ã‚‹ã¾ã§ç¹°ã‚Šè¿”ã™
   */
  test('[å¿…é ˆ] DBã®å…¨ã‚µãƒ–ã‚¹ãƒ­ãƒƒãƒˆç¨®åˆ¥ãŒUIã«è¡¨ç¤ºã•ã‚Œã‚‹', async ({ page }) => {
    test.setTimeout(180000); // 3åˆ†
    
    // 1. DBã‹ã‚‰ä¾‹æ–‡æ§‹é€ ã‚’ãƒãƒƒãƒ—åŒ–ï¼šå„ä¾‹æ–‡ã®å„è¦ªã‚¹ãƒ­ãƒƒãƒˆã«ã©ã®ã‚µãƒ–ã‚¹ãƒ­ãƒƒãƒˆãŒã‚ã‚‹ã‹
    const exampleStructure = new Map<string, Map<string, Set<string>>>();
    // å½¢å¼: Map<"V_group_key/ä¾‹æ–‡ID", Map<"è¦ªã‚¹ãƒ­ãƒƒãƒˆ", Set<"ã‚µãƒ–ã‚¹ãƒ­ãƒƒãƒˆç¨®åˆ¥">>>
    
    for (const row of dbData) {
      if (row.SubslotID && row.Slot && row.V_group_key && row.ä¾‹æ–‡ID) {
        const exampleKey = `${row.V_group_key}/${row.ä¾‹æ–‡ID}`;
        if (!exampleStructure.has(exampleKey)) {
          exampleStructure.set(exampleKey, new Map());
        }
        const example = exampleStructure.get(exampleKey)!;
        const parentSlot = row.Slot.toLowerCase();
        if (!example.has(parentSlot)) {
          example.set(parentSlot, new Set());
        }
        example.get(parentSlot)!.add(row.SubslotID);
      }
    }
    
    console.log(`ğŸ“‹ DBå†…ã®ä¾‹æ–‡æ•°: ${exampleStructure.size}`);
    
    // DBå†…ã®å…¨ã‚µãƒ–ã‚¹ãƒ­ãƒƒãƒˆçµ„ã¿åˆã‚ã›ï¼ˆè¦ª+ã‚µãƒ–ï¼‰ã‚’é›†è¨ˆ
    const allDbCombinations = new Set<string>();
    exampleStructure.forEach((parentMap, exampleKey) => {
      parentMap.forEach((subslots, parentSlot) => {
        subslots.forEach(subslotId => {
          allDbCombinations.add(`${parentSlot}-${subslotId}`);
        });
      });
    });
    
    console.log(`ğŸ“Š DBå†…ã®å…¨ã‚µãƒ–ã‚¹ãƒ­ãƒƒãƒˆçµ„ã¿åˆã‚ã›: ${allDbCombinations.size}ç¨®é¡`);
    console.log(`   ${Array.from(allDbCombinations).sort().join(', ')}`);
    
    if (allDbCombinations.size === 0) {
      console.log('âš ï¸ DBã«ã‚µãƒ–ã‚¹ãƒ­ãƒƒãƒˆãŒå­˜åœ¨ã—ãªã„');
      test.skip();
      return;
    }
    
    // 2. ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºã—ã¦å„ä¾‹æ–‡ã®å„è¦ªã‚¹ãƒ­ãƒƒãƒˆã®ã‚µãƒ–ã‚¹ãƒ­ãƒƒãƒˆãŒå…¨ã¦è¡¨ç¤ºã•ã‚Œã‚‹ã‹ç¢ºèª
    const uiFoundCombinations = new Set<string>();
    const randomizeBtn = page.locator('#randomize-all');
    const MAX_RANDOMIZE = 50;
    
    for (let i = 0; i < MAX_RANDOMIZE; i++) {
      await randomizeBtn.click();
      await page.waitForTimeout(1000);
      
      // ç¾åœ¨è¡¨ç¤ºä¸­ã®ã‚µãƒ–ã‚¹ãƒ­ãƒƒãƒˆãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã‚’å–å¾—
      const toggleBtns = page.locator('button[data-subslot-toggle]');
      const toggleCount = await toggleBtns.count();
      
      if (toggleCount === 0) {
        console.log(`  âš ï¸ ${i + 1}å›ç›®: ã‚µãƒ–ã‚¹ãƒ­ãƒƒãƒˆãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ãªã—ï¼ˆã‚¹ã‚­ãƒƒãƒ—ï¼‰`);
        continue;
      }
      
      console.log(`\nâ”â”â” ${i + 1}å›ç›®ã®ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚º: ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ ${toggleCount}å€‹ â”â”â”`);
      
      // å„è¦ªã‚¹ãƒ­ãƒƒãƒˆã‚’é–‹ã„ã¦ã‚µãƒ–ã‚¹ãƒ­ãƒƒãƒˆã‚’ç¢ºèª
      for (let j = 0; j < toggleCount; j++) {
        const toggleBtn = toggleBtns.nth(j);
        const parentSlot = await toggleBtn.getAttribute('data-subslot-toggle');
        if (!parentSlot) continue;
        
        // è¦ªã‚¹ãƒ­ãƒƒãƒˆã‚’é–‹ã
        await toggleBtn.evaluate((btn: HTMLElement) => btn.click());
        await page.waitForTimeout(500);
        
        // é™çš„DOMå†…ã®å®Ÿéš›ã®ã‚µãƒ–ã‚¹ãƒ­ãƒƒãƒˆè¦ç´ ã‚’ç¢ºèª
        const staticWrapperId = `slot-${parentSlot}-sub`;
        const actualSubslots = await page.evaluate((wrapperId) => {
          const wrapper = document.getElementById(wrapperId);
          if (!wrapper) return [];
          
          const containers = wrapper.querySelectorAll('.slot-container, .subslot-container');
          const found: string[] = [];
          
          containers.forEach((container) => {
            const id = container.id;
            if (!id) return;
            
            // IDå½¢å¼: "slot-s-sub-s" â†’ sub-s
            const match = id.match(/slot-\w+-sub-(\w+)$/);
            if (!match) return;
            
            // å®Ÿéš›ã«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒã‚ã‚‹ã‹ç¢ºèªï¼ˆ.slot-phraseã¾ãŸã¯.slot-textã«å†…å®¹ãŒã‚ã‚‹ã‹ï¼‰
            const slotPhrase = container.querySelector('.slot-phrase');
            const slotText = container.querySelector('.slot-text');
            const hasContent = (slotPhrase?.textContent?.trim() && slotPhrase.textContent.trim() !== '') ||
                             (slotText?.textContent?.trim() && slotText.textContent.trim() !== '');
            
            if (hasContent) {
              const subslotType = `sub-${match[1]}`;
              found.push(subslotType);
            }
          });
          
          return found;
        }, staticWrapperId);
        
        // è¦‹ã¤ã‹ã£ãŸã‚µãƒ–ã‚¹ãƒ­ãƒƒãƒˆã‚’è¨˜éŒ²
        actualSubslots.forEach(subslotId => {
          const combination = `${parentSlot}-${subslotId}`;
          if (!uiFoundCombinations.has(combination)) {
            uiFoundCombinations.add(combination);
            console.log(`  âœ… ${combination} ã‚’ç™ºè¦‹`);
          }
        });
        
        // è¦ªã‚¹ãƒ­ãƒƒãƒˆã‚’é–‰ã˜ã‚‹
        await toggleBtn.evaluate((btn: HTMLElement) => btn.click());
        await page.waitForTimeout(300);
      }
      
      // å…¨ç¨®é¡æƒã£ãŸã‚‰æ—©æœŸçµ‚äº†
      if (uiFoundCombinations.size >= allDbCombinations.size) {
        console.log(`\nâœ… ${i + 1}å›ã®ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºã§å…¨ã‚µãƒ–ã‚¹ãƒ­ãƒƒãƒˆçµ„ã¿åˆã‚ã›ãŒå‡ºç¾`);
        break;
      }
      
      if ((i + 1) % 10 === 0) {
        console.log(`\nğŸ“Š ${i + 1}å›ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚º: ${uiFoundCombinations.size}/${allDbCombinations.size}ç¨®é¡å‡ºç¾`);
      }
    }
    
    // 3. æ¤œè¨¼ï¼šDBå†…ã®å…¨çµ„ã¿åˆã‚ã›ãŒUIã«å‡ºç¾ã—ãŸã‹
    const missingCombinations: string[] = [];
    allDbCombinations.forEach(combination => {
      if (!uiFoundCombinations.has(combination)) {
        missingCombinations.push(combination);
      }
    });
    
    console.log(`\nğŸ“Š æœ€çµ‚çµæœ:`);
    console.log(`   DBå†…ã®å…¨çµ„ã¿åˆã‚ã›: ${allDbCombinations.size}ç¨®é¡`);
    console.log(`   UIå‡ºç¾: ${uiFoundCombinations.size}ç¨®é¡`);
    
    if (missingCombinations.length > 0) {
      console.log(`\nâŒ æœªå‡ºç¾: ${missingCombinations.join(', ')}`);
    }
    
    expect(uiFoundCombinations.size).toBeGreaterThanOrEqual(allDbCombinations.size);
    console.log('\nğŸ‰ DBå†…ã®å…¨ã‚µãƒ–ã‚¹ãƒ­ãƒƒãƒˆç¨®åˆ¥ãŒé™çš„ã‚¹ãƒ­ãƒƒãƒˆDOMã«æ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹');
  });
});