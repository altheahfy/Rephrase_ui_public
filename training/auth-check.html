<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>èªè¨¼ç¢ºèªä¸­... - Rephrase</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      text-align: center;
    }
    
    .auth-check-container {
      background: rgba(255, 255, 255, 0.1);
      padding: 40px;
      border-radius: 15px;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    h1 {
      margin: 0 0 10px;
      font-size: 24px;
    }
    
    p {
      margin: 0;
      opacity: 0.9;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <div class="auth-check-container">
    <div class="spinner"></div>
    <h1>ğŸ” èªè¨¼ç¢ºèªä¸­</h1>
    <p>ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„...</p>
  </div>

  <!-- ç°¡æ˜“ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ -->
  <script>
    window.securityUtils = {
      escapeHtml: function(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      },
      
      secureLocalStorageSet: function(key, data) {
        try {
          const jsonString = JSON.stringify(data);
          const encoded = btoa(jsonString);
          localStorage.setItem(key, encoded);
        } catch (error) {
          console.error('Storage set error:', error);
        }
      },
      
      secureLocalStorageGet: function(key) {
        try {
          const encoded = localStorage.getItem(key);
          if (!encoded) return null;
          
          const jsonString = atob(encoded);
          return JSON.parse(jsonString);
        } catch (error) {
          console.error('Storage get error:', error);
          return null;
        }
      }
    };
  </script>

  <!-- èªè¨¼ã‚·ã‚¹ãƒ†ãƒ èª­ã¿è¾¼ã¿ -->
  <script src="js/rate-limiter.js"></script>
  <script src="js/error-handler.js"></script>
  <script src="js/security.js"></script>
  <script src="js/auth.js"></script>

  <script>
    // èªè¨¼ãƒã‚§ãƒƒã‚¯å‡¦ç†
    function performAuthCheck() {
      console.log('ğŸ” èªè¨¼ãƒã‚§ãƒƒã‚¯é–‹å§‹ - auth-check.html');
      
      // ç¾åœ¨ã®localStorageã®çŠ¶æ…‹ã‚’ç¢ºèª
      const sessionData = localStorage.getItem('userSession');
      const rephraseSession = localStorage.getItem('rephrase_session');
      
      console.log('ğŸ“Š localStorageçŠ¶æ…‹ç¢ºèª:', {
        userSession: !!sessionData,
        rephrase_session: !!rephraseSession,
        userSessionData: sessionData,
        rephraseSessionData: rephraseSession
      });
      
      // èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹ã¾ã§å¾…æ©Ÿ
      function waitForAuth() {
        console.log('â³ èªè¨¼ã‚·ã‚¹ãƒ†ãƒ å¾…æ©Ÿä¸­...', {
          authSystem: !!window.authSystem,
          securityUtils: !!window.securityUtils
        });
        
        if (window.authSystem && window.securityUtils) {
          console.log('âœ… èªè¨¼ã‚·ã‚¹ãƒ†ãƒ èª­ã¿è¾¼ã¿å®Œäº†');
          
          try {
            // ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯
            const isLoggedIn = window.authSystem.isLoggedIn();
            console.log('ğŸ” ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ç¢ºèªçµæœ:', isLoggedIn);
            
            // è©³ç´°ãªãƒ‡ãƒãƒƒã‚°æƒ…å ±
            const currentUser = window.authSystem.getCurrentUser();
            console.log('ğŸ‘¤ ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±:', currentUser);
            
            if (isLoggedIn && currentUser) {
              console.log('âœ… èªè¨¼æ¸ˆã¿ç¢ºèª - ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°UIã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ');
              // èªè¨¼æ¸ˆã¿ã®å ´åˆã¯ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°UIã¸ï¼ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è»¢é€ï¼‰
              setTimeout(() => {
                const currentParams = new URLSearchParams(window.location.search);
                const grammarParam = currentParams.get('grammar');
                if (grammarParam) {
                  window.location.href = `index.html?grammar=${encodeURIComponent(grammarParam)}`;
                } else {
                  window.location.href = 'index.html';
                }
              }, 1000);
            } else {
              console.log('âŒ æœªèªè¨¼ã¾ãŸã¯ç„¡åŠ¹ã‚»ãƒƒã‚·ãƒ§ãƒ³ - èªè¨¼ãƒšãƒ¼ã‚¸ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ');
              // æœªèªè¨¼ã®å ´åˆã¯èªè¨¼ãƒšãƒ¼ã‚¸ã¸ï¼ˆãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå…ˆã‚’æŒ‡å®šï¼‰
              setTimeout(() => {
                const currentParams = new URLSearchParams(window.location.search);
                const grammarParam = currentParams.get('grammar');
                let redirectTarget = 'index.html';
                if (grammarParam) {
                  redirectTarget = `index.html?grammar=${encodeURIComponent(grammarParam)}`;
                }
                const redirectUrl = `auth.html?redirect=${encodeURIComponent(redirectTarget)}`;
                window.location.href = redirectUrl;
              }, 1000);
            }
          } catch (error) {
            console.error('âŒ èªè¨¼ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
            // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯èªè¨¼ãƒšãƒ¼ã‚¸ã¸
            setTimeout(() => {
              window.location.href = 'auth.html';
            }, 1000);
          }
        } else {
          // èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ãŒã¾ã èª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„å ´åˆã¯100mså¾Œã«å†è©¦è¡Œ
          setTimeout(waitForAuth, 100);
        }
      }
      
      // èªè¨¼ãƒã‚§ãƒƒã‚¯é–‹å§‹
      waitForAuth();
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«èªè¨¼ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
    document.addEventListener('DOMContentLoaded', performAuthCheck);
  </script>
</body>
</html>
